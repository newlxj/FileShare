import{d as J,r as C,a as j,o as q,c as x,b as d,e as o,w as a,f as r,g as D,t as m,E as u,h as _,i as G,j as R,k as K,_ as A}from"./index-B_Y7wqn5.js";const H={class:"share-container"},Q={class:"directory-tree"},W={class:"custom-tree-node"},X={class:"file-list"},Y={key:0,class:"empty-tip"},Z={key:1,class:"empty-tip"},I={class:"file-name"},z=J({__name:"ShareView",setup(ee){const S=C([]),w=C(null),y=C([]),h=j(new Map),v=j(new Map),L=async()=>{try{const t=await(await fetch("/filesharePreview/api/directories/shared")).json();S.value=P(t)}catch(e){u.error("加载共享目录数据失败"),console.error(e)}},P=e=>e.map(t=>({...t,label:t.name,children:t.children?P(t.children):void 0,password:t.password})),F=async e=>{try{if(!h.get(e)&&!await b(e))return;const t=await fetch(`/filesharePreview/api/files/shared?directoryId=${e}`);y.value=await t.json()}catch(t){u.error("加载共享文件列表失败"),console.error(t)}},b=async e=>{try{const s=await(await fetch(`/filesharePreview/api/directories/${e}/verify`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({password:""})})).json();if(s.valid||s.message==="Password verified successfully")return h.set(e,!0),v.set(e,""),!0;const{value:n}=await K.prompt("此目录受密码保护，请输入密码","密码验证",{confirmButtonText:"确定",cancelButtonText:"取消",inputType:"password",inputValidator:i=>i?!0:"密码不能为空"});if(!n)return!1;const l=await(await fetch(`/filesharePreview/api/directories/${e}/verify`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({password:n})})).json();return l.valid||l.message==="Password verified successfully"?(h.set(e,!0),v.set(e,n),!0):(u.error("密码错误"),!1)}catch(t){return t!=="cancel"&&(u.error("验证密码失败"),console.error(t)),!1}},V=e=>{w.value=e,F(e.id)},k=async e=>{try{if(!h.get(e.directoryId)&&!await b(e.directoryId))return;const t=v.get(e.directoryId)||"",s=await fetch(`/filesharePreview/api/files/${e.id}/download?password=${t}`);if(s.status===403){const i=await s.json();if(i.requirePassword)return await b(i.directoryId)?k(e):void 0}const n=await s.blob(),p=window.URL.createObjectURL(n),l=document.createElement("a");l.href=p,l.download=e.name,document.body.appendChild(l),l.click(),window.URL.revokeObjectURL(p),document.body.removeChild(l),u.success(`开始下载文件: ${e.name}`)}catch(t){u.error("下载文件失败"),console.error(t)}},$=e=>e<1024?e+" B":e<1024*1024?(e/1024).toFixed(2)+" KB":e<1024*1024*1024?(e/(1024*1024)).toFixed(2)+" MB":(e/(1024*1024*1024)).toFixed(2)+" GB",B=e=>e.filter(t=>t.isShared||t.children&&t.children.some(s=>s.isShared)).map(t=>t.children?{...t,children:B(t.children)}:t);return q(()=>{L()}),(e,t)=>{var T;const s=r("Folder"),n=r("el-icon"),p=r("Lock"),l=r("el-tree"),i=r("el-empty"),N=r("Document"),M=r("el-link"),f=r("el-table-column"),O=r("Download"),E=r("el-button"),U=r("el-table");return _(),x("div",H,[d("div",Q,[t[0]||(t[0]=d("h2",null,"共享目录",-1)),o(l,{data:B(S.value),"node-key":"id","default-expand-all":"","expand-on-click-node":!1,"highlight-current":"",onNodeClick:V},{default:a(({node:c,data:g})=>[d("span",W,[o(n,null,{default:a(()=>[o(s)]),_:1}),d("span",null,m(c.label),1),g.password?(_(),D(n,{key:0,class:"lock-icon"},{default:a(()=>[o(p)]),_:1})):G("",!0)])]),_:1},8,["data"])]),d("div",X,[d("h2",null,"共享文件 - "+m(((T=w.value)==null?void 0:T.label)||"请选择目录"),1),w.value?y.value.length===0?(_(),x("div",Z,[o(i,{description:"该目录下暂无共享文件"})])):(_(),D(U,{key:2,data:y.value,style:{width:"100%"}},{default:a(()=>[o(f,{label:"文件名","min-width":"200"},{default:a(({row:c})=>[d("div",I,[o(n,null,{default:a(()=>[o(N)]),_:1}),o(M,{type:"primary",onClick:g=>k(c)},{default:a(()=>[R(m(c.name),1)]),_:2},1032,["onClick"])])]),_:1}),o(f,{prop:"type",label:"类型",width:"100"}),o(f,{label:"大小",width:"120"},{default:a(({row:c})=>[R(m($(c.size)),1)]),_:1}),o(f,{prop:"addTime",label:"添加时间",width:"180"}),o(f,{label:"操作",width:"120"},{default:a(({row:c})=>[o(E,{type:"primary",size:"small",onClick:g=>k(c)},{default:a(()=>[o(n,null,{default:a(()=>[o(O)]),_:1}),t[1]||(t[1]=R(" 下载 "))]),_:2},1032,["onClick"])]),_:1})]),_:1},8,["data"])):(_(),x("div",Y," 请先从左侧选择一个共享目录 "))])])}}}),oe=A(z,[["__scopeId","data-v-50c585c1"]]);export{oe as default};

import{d as we,r as $,a as ge,o as _e,c as E,b as f,e as i,w as l,l as q,f as h,F as ke,m as be,v as Te,n as xe,t as V,g as N,E as r,k as x,p as Be,j as B,i as P,u as X,q as Ce,s as Se,h as _,_ as $e}from"./index-B_Y7wqn5.js";const Ne={class:"manage-container"},De={key:0,class:"login-container"},Ae={class:"login-form"},je={class:"directory-tree"},Ee={class:"header-actions"},Ve={class:"custom-tree-node"},ze={class:"file-list-header"},Ie={key:0,class:"empty-tip"},Pe={key:1,class:"empty-tip"},Fe={class:"file-name"},Oe=we({__name:"ManageView",setup(Je){const D=$(!1),C=$([]),o=$(null),v=$([]),A=$(""),m=()=>{const e=document.cookie.split(";");for(const t of e){const[n,a]=t.trim().split("=");if(n==="admin_token")return a}return null},Y=()=>{const e=m();D.value=!!e},F=$(!1),O=ge({top:"0px",left:"0px"}),j=async()=>{try{const e=m();if(!e){r.error("未授权，请先登录");return}const t=await fetch("/fileshare/api/directories",{headers:{Authorization:`Bearer ${e}`}});if(t.status===401){r.error("授权已过期，请重新登录"),z();return}const n=await t.json();C.value=R(n)}catch(e){r.error("加载目录数据失败"),console.error(e)}},J=async e=>{try{const t=m();if(!t){r.error("未授权，请先登录");return}const n=await fetch(`/fileshare/api/files?directoryId=${e}`,{headers:{Authorization:`Bearer ${t}`}});if(n.status===401){r.error("授权已过期，请重新登录"),z();return}v.value=await n.json()}catch(t){r.error("加载文件列表失败"),console.error(t)}},Q=e=>{o.value=e,J(e.id)},W=(e,t)=>{e.preventDefault(),o.value=t,O.top=`${e.clientY}px`,O.left=`${e.clientX}px`,F.value=!0,document.addEventListener("click",Z,{once:!0})},Z=()=>{F.value=!1},ee=async()=>{try{if(!o.value){r.warning("请先选择一个目录");return}const{value:e}=await x.prompt(`<div>
        
        <div>
          <label style="display: block; margin-bottom: 5px;">目录类型</label>
          <div style="display: flex; gap: 15px;">
            <label style="display: flex; align-items: center;">
              <input type="radio" name="dirType" value="storage" checked /> 存储型
            </label>
            <label style="display: flex; align-items: center;">
              <input type="radio" name="dirType" value="link" /> 链接型
            </label>
          </div>
        </div>
        <div style="margin-bottom: 15px;">
          <label style="display: block; margin-bottom: 5px;">目录名称</label>
          <input 
            class="el-input__inner" 
            value="" 
            placeholder="输入目录名称，在这里输入下面那个不是" 
            id="dirName" 
            style="
              width: 80vh;
              border: 1px solid #dcdfe6;
              border-radius: 4px;
              padding: 0 15px;
              height: 32px;
              line-height: 32px;
              background-color: #fff;
              color: #606266;
            "
          />
        </div>
      </div>`,"添加目录",{confirmButtonText:"确定",cancelButtonText:"取消",dangerouslyUseHTMLString:!0,inputValidator:()=>{const c=document.getElementById("dirName");return!c||!c.value.trim()?"目录名称不能为空":!0},beforeClose:(c,p,g)=>{if(c==="confirm"){const b=document.getElementById("dirName"),y=document.getElementsByName("dirType");let k="storage";for(const I of y)if(I.checked){k=I.value;break}const S={name:b.value.trim(),dirType:k};p.inputValue=JSON.stringify(S)}g()}});if(!e)return;const{name:t,dirType:n}=JSON.parse(e),a=m();if(!a){r.error("未授权，请先登录");return}const s=await fetch("/fileshare/api/directories",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${a}`},body:JSON.stringify({name:t,parentId:o.value.id,dirType:n})});if(!s.ok){const c=await s.json();if(c.error&&c.error.includes("Adding link directories is not allowed by server configuration")){r.error("服务器配置不允许创建链接型目录，请联系管理员");return}throw new Error(c.error||"添加目录失败")}await j();const u={id:Date.now().toString(),label:t,isShared:!1,parentId:o.value.id,dirType:n,children:[]};o.value.children||(o.value.children=[]),o.value.children.push(u),r.success("添加目录成功")}catch(e){r.error("添加目录失败"),console.error(e)}},te=async()=>{try{if(!o.value){r.warning("请先选择一个目录");return}await x.confirm(`确定要删除目录 "${o.value.label}" 吗？删除后将无法恢复，且会删除该目录下的所有文件。`,"删除目录",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});const e=m();if(!e){r.error("未授权，请先登录");return}if(await fetch(`/fileshare/api/directories/${o.value.id}`,{method:"DELETE",headers:{Authorization:`Bearer ${e}`}}),await j(),o.value.parentId){const t=M(C.value,o.value.parentId);if(t&&t.children){const n=t.children.findIndex(a=>{var s;return a.id===((s=o.value)==null?void 0:s.id)});n!==-1&&(t.children.splice(n,1),r.success("删除目录成功"),o.value=null,v.value=[])}}else{const t=C.value.findIndex(n=>{var a;return n.id===((a=o.value)==null?void 0:a.id)});t!==-1&&(C.value.splice(t,1),r.success("删除目录成功"),o.value=null,v.value=[])}}catch(e){e!=="cancel"&&(r.error("删除目录失败"),console.error(e))}},re=async()=>{try{if(!o.value){r.warning("请先选择一个目录");return}const{value:e}=await x.prompt("请输入新的目录名称","重命名目录",{confirmButtonText:"确定",cancelButtonText:"取消",inputValue:o.value.label,inputValidator:n=>n?!0:"目录名称不能为空"});if(!e||e===o.value.label)return;const t=m();if(!t){r.error("未授权，请先登录");return}await fetch(`/fileshare/api/directories/${o.value.id}`,{method:"PUT",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify({name:e})}),await j(),o.value.label=e,r.success("重命名目录成功")}catch(e){e!=="cancel"&&(r.error("重命名目录失败"),console.error(e))}},ne=async()=>{try{if(!o.value){r.warning("请先选择一个目录");return}const e=!o.value.isShared,t=m();if(!t){r.error("未授权，请先登录");return}await fetch(`/fileshare/api/directories/${o.value.id}/share`,{method:"PATCH",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify({isShared:e})}),o.value.isShared=e,e?H(o.value.parentId,!0):U(o.value,!1),r.success(`目录已${e?"共享":"取消共享"}`)}catch(e){r.error("更新目录共享状态失败"),console.error(e)}},H=async(e,t)=>{if(!e)return;const n=M(C.value,e);if(!n||n.isShared===t)return;const a=m();if(a)try{await fetch(`/fileshare/api/directories/${n.id}/share`,{method:"PATCH",headers:{"Content-Type":"application/json",Authorization:`Bearer ${a}`},body:JSON.stringify({isShared:t})}),n.isShared=t,H(n.parentId,t)}catch(s){console.error("更新父级目录共享状态失败:",s)}},U=async(e,t)=>{if(!e.children||e.children.length===0)return;const n=m();if(n)for(const a of e.children){if(a.isShared!==t)try{await fetch(`/fileshare/api/directories/${a.id}/share`,{method:"PATCH",headers:{"Content-Type":"application/json",Authorization:`Bearer ${n}`},body:JSON.stringify({isShared:t})}),a.isShared=t}catch(s){console.error("更新子目录共享状态失败:",s);continue}U(a,t)}},oe=async()=>{try{if(!o.value){r.warning("请先选择一个目录");return}const{value:e}=await x.prompt("请输入目录密码（留空表示不设置密码）","设置密码",{confirmButtonText:"确定",cancelButtonText:"取消",inputType:"password",inputValue:""}),t=m();if(!t){r.error("未授权，请先登录");return}await fetch(`/fileshare/api/directories/${o.value.id}/password`,{method:"PATCH",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify({password:e})}),r.success(e?"密码设置成功":"密码已清除")}catch(e){e!=="cancel"&&(r.error("设置密码失败"),console.error(e))}},ae=()=>{if(!o.value){r.warning("请先选择一个目录");return}const e=document.createElement("input");e.type="file",e.multiple=!0,e.onchange=ie,e.click()},ie=async e=>{const t=e.target;if(!(!t.files||!o.value))try{const n=Array.from(t.files),a=o.value.dirType||"storage",s=m();if(!s){r.error("未授权，请先登录");return}const d=new FormData;if(a==="link"){const u=n.map(y=>y.name).join(`
`),{value:c}=await x.prompt("请在文件名前补充完整路径，多个文件路径请用换行分隔，例如:c:\\temp\\showInfo.png  或linux /opt/dameng/info.log","链接型目录文件路径",{confirmButtonText:"确定",cancelButtonText:"取消",inputType:"textarea",inputValue:u,inputValidator:y=>y?!0:"文件路径不能为空"});if(!c)return;const p=c.split(`
`).filter(y=>y.trim()!=="");d.append("filePaths",JSON.stringify(p)),d.append("directoryId",o.value.id),d.append("dirType","link");const g=await fetch("/fileshare/api/files",{method:"POST",headers:{Authorization:`Bearer ${s}`},body:d});if(!g.ok){const y=await g.json();if(y.error&&y.error.includes("Adding files to link directories is not allowed by server configuration")){r.error("服务器配置不允许向链接型目录添加文件，请联系管理员");return}throw new Error(y.error||"添加文件失败")}const b=await g.json();v.value=[...v.value,...b],r.success(`成功添加 ${b.length} 个文件`)}else{n.forEach(p=>d.append("files",p)),d.append("directoryId",o.value.id),d.append("dirType","storage");const u=await fetch("/fileshare/api/files",{method:"POST",headers:{Authorization:`Bearer ${s}`},body:d});if(!u.ok){const p=await u.json();if(p.error&&p.error.includes("Adding files to link directories is not allowed by server configuration")){r.error("服务器配置不允许向链接型目录添加文件，请联系管理员");return}throw new Error(p.error||"添加文件失败")}const c=await u.json();v.value=[...v.value,...c],r.success(`成功添加 ${c.length} 个文件`)}await J(o.value.id)}catch(n){n!=="cancel"&&(r.error("添加文件失败"),console.error(n))}},le=async e=>{try{const t=m();if(!t){r.error("未授权，请先登录");return}const n=await fetch(`/fileshare/api/files/${e.id}/download`,{headers:{Authorization:`Bearer ${t}`}});if(n.status===401){r.error("授权已过期，请重新登录"),z();return}if(!n.ok){const u=await n.json();throw new Error(u.error||"下载文件失败")}const a=await n.blob(),s=window.URL.createObjectURL(a),d=document.createElement("a");d.href=s,d.download=e.name,document.body.appendChild(d),d.click(),window.URL.revokeObjectURL(s),document.body.removeChild(d),r.success(`开始下载文件: ${e.name}`)}catch(t){r.error("下载文件失败"),console.error(t)}},se=async e=>{try{await x.confirm(`确定要删除文件 "${e.name}" 吗？删除后将无法恢复。`,"删除文件",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"});const t=m();if(!t){r.error("未授权，请先登录");return}await fetch(`/fileshare/api/files/${e.id}`,{method:"DELETE",headers:{Authorization:`Bearer ${t}`}});const n=v.value.findIndex(a=>a.id===e.id);n!==-1&&(v.value.splice(n,1),r.success("删除文件成功"))}catch(t){t!=="cancel"&&(r.error("删除文件失败"),console.error(t))}},ce=async e=>{try{const{value:t}=await x.prompt("请输入新的文件名称","重命名文件",{confirmButtonText:"确定",cancelButtonText:"取消",inputValue:e.name,inputValidator:a=>a?!0:"文件名称不能为空"});if(!t||t===e.name)return;const n=m();if(!n){r.error("未授权，请先登录");return}await fetch(`/fileshare/api/files/${e.id}`,{method:"PATCH",headers:{"Content-Type":"application/json",Authorization:`Bearer ${n}`},body:JSON.stringify({name:t})}),e.name=t,r.success("重命名文件成功")}catch(t){t!=="cancel"&&(r.error("重命名文件失败"),console.error(t))}},de=async e=>{try{const t=!e.isShared,n=m();if(!n){r.error("未授权，请先登录");return}await fetch(`/fileshare/api/files/${e.id}/share`,{method:"PATCH",headers:{"Content-Type":"application/json",Authorization:`Bearer ${n}`},body:JSON.stringify({isShared:t})}),e.isShared=t,r.success(`文件已${t?"共享":"取消共享"}`)}catch(t){r.error("更新文件共享状态失败"),console.error(t)}},ue=async e=>{var t,n;if(e.preventDefault(),e.stopPropagation(),!o.value){r.warning("请先选择一个目录");return}if(!((n=(t=e.dataTransfer)==null?void 0:t.files)!=null&&n.length)){r.warning("没有有效的文件");return}try{const a=Array.from(e.dataTransfer.files),s=o.value.dirType||"storage",d=m();if(!d){r.error("未授权，请先登录");return}const u=new FormData;if(s==="link"){const g=a.map(k=>k.name).join(`
`),{value:b}=await x.prompt("请在文件名前补充完整路径，多个文件路径请用换行分隔，例如:c:\\temp\\showInfo.png  或linux /opt/dameng/info.log","链接型目录文件路径",{confirmButtonText:"确定",cancelButtonText:"取消",inputType:"textarea",inputValue:g,inputValidator:k=>k?!0:"文件路径不能为空"});if(!b)return;const y=b.split(`
`).filter(k=>k.trim()!=="");u.append("filePaths",JSON.stringify(y)),u.append("directoryId",o.value.id),u.append("dirType","link")}else a.forEach(g=>u.append("files",g)),u.append("directoryId",o.value.id),u.append("dirType","storage");const p=await(await fetch("/fileshare/api/files",{method:"POST",headers:{Authorization:`Bearer ${d}`},body:u})).json();Array.isArray(p)&&p.length>0?(v.value=[...v.value,...p],r.success(`成功添加 ${p.length} 个文件`)):r.warning("未能添加文件，请检查文件路径是否正确"),await J(o.value.id)}catch(a){r.error("添加文件失败"),console.error(a)}},pe=e=>{e.preventDefault()},fe=e=>e<1024?e+" B":e<1024*1024?(e/1024).toFixed(2)+" KB":e<1024*1024*1024?(e/(1024*1024)).toFixed(2)+" MB":(e/(1024*1024*1024)).toFixed(2)+" GB",R=e=>e.map(t=>({...t,label:t.name,children:t.children?R(t.children):void 0})),M=(e,t)=>{for(const n of e){if(n.id===t)return n;if(n.children&&n.children.length>0){const a=M(n.children,t);if(a)return a}}return null},L=async()=>{try{if(!A.value){r.warning("请输入管理密码");return}const e=await fetch("/fileshare/api/admin/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({password:A.value})});if(!e.ok){const n=await e.json();r.error(n.error||"登录失败，密码错误");return}const t=await e.json();document.cookie=`admin_token=${t.token}; path=/; max-age=86400`,D.value=!0,A.value="",r.success("登录成功"),j()}catch(e){r.error("登录失败，请稍后重试"),console.error(e)}},z=()=>{document.cookie="admin_token=; path=/; expires=Thu, 01 Jan 1970 00:00:01 GMT;",D.value=!1,C.value=[],v.value=[],o.value=null,r.success("已退出登录")};return _e(()=>{Y(),D.value&&j()}),(e,t)=>{var K,G;const n=h("el-input"),a=h("el-form-item"),s=h("el-button"),d=h("el-form"),u=h("Folder"),c=h("el-icon"),p=h("el-tag"),g=h("el-tree"),b=h("Plus"),y=h("el-empty"),k=h("Document"),S=h("el-table-column"),I=h("Edit"),he=h("Share"),me=h("Delete"),ye=h("el-button-group"),ve=h("el-table");return _(),E("div",Ne,[D.value?(_(),E(ke,{key:1},[f("div",je,[f("div",Ee,[t[4]||(t[4]=f("h2",null,"目录管理",-1)),i(s,{type:"danger",size:"small",onClick:z},{default:l(()=>t[3]||(t[3]=[B("退出登录")])),_:1})]),i(g,{data:C.value,"node-key":"id","default-expand-all":"","expand-on-click-node":!1,"highlight-current":"",onNodeClick:Q,onNodeContextmenu:W},{default:l(({node:w,data:T})=>[f("span",Ve,[i(c,null,{default:l(()=>[i(u)]),_:1}),f("span",null,V(w.label),1),T.isShared?(_(),N(p,{key:0,size:"small",type:"success",effect:"plain"},{default:l(()=>t[5]||(t[5]=[B("已共享")])),_:1})):P("",!0),T.dirType==="link"?(_(),N(p,{key:1,size:"small",type:"info",effect:"plain"},{default:l(()=>t[6]||(t[6]=[B("链接型")])),_:1})):T.dirType==="storage"?(_(),N(p,{key:2,size:"small",type:"primary",effect:"plain"},{default:l(()=>t[7]||(t[7]=[B("存储型")])),_:1})):P("",!0),T.password?(_(),N(c,{key:3,color:"#E6A23C"},{default:l(()=>[i(X(Ce))]),_:1})):P("",!0)])]),_:1},8,["data"]),be(f("div",{class:"context-menu",style:xe(O)},[f("ul",null,[f("li",{onClick:ee},"添加子目录"),f("li",{onClick:re},"重命名"),f("li",{onClick:ne},V((K=o.value)!=null&&K.isShared?"取消共享":"设为共享"),1),f("li",{onClick:oe},"设置密码"),f("li",{onClick:te,class:"danger"},"删除")])],4),[[Te,F.value]])]),f("div",{class:"file-list",onDragover:pe,onDrop:ue},[f("div",ze,[f("h2",null,"文件列表 - "+V(((G=o.value)==null?void 0:G.label)||"请选择目录"),1),i(s,{type:"primary",disabled:!o.value,onClick:ae},{default:l(()=>[i(c,null,{default:l(()=>[i(b)]),_:1}),t[8]||(t[8]=B(" 添加文件 "))]),_:1},8,["disabled"])]),o.value?v.value.length===0?(_(),E("div",Pe,[i(y,{description:"暂无文件，请添加文件或拖拽文件到此处"})])):(_(),N(ve,{key:2,data:v.value,style:{width:"100%"}},{default:l(()=>[i(S,{label:"文件名","min-width":"200"},{default:l(({row:w})=>[f("div",Fe,[i(c,null,{default:l(()=>[i(k)]),_:1}),f("span",null,V(w.name),1),w.isShared?(_(),N(p,{key:0,size:"small",type:"success",effect:"plain"},{default:l(()=>t[9]||(t[9]=[B("已共享")])),_:1})):P("",!0)])]),_:1}),i(S,{prop:"type",label:"类型",width:"100"}),i(S,{label:"大小",width:"120"},{default:l(({row:w})=>[B(V(fe(w.size)),1)]),_:1}),i(S,{prop:"addTime",label:"添加时间",width:"180"}),i(S,{label:"操作",width:"220"},{default:l(({row:w})=>[i(ye,null,{default:l(()=>[i(s,{size:"small",onClick:T=>ce(w)},{default:l(()=>[i(c,null,{default:l(()=>[i(I)]),_:1})]),_:2},1032,["onClick"]),i(s,{size:"small",type:w.isShared?"success":"info",onClick:T=>de(w)},{default:l(()=>[i(c,null,{default:l(()=>[i(he)]),_:1})]),_:2},1032,["type","onClick"]),i(s,{size:"small",type:"primary",onClick:T=>le(w)},{default:l(()=>[i(c,null,{default:l(()=>[i(X(Se))]),_:1})]),_:2},1032,["onClick"]),i(s,{size:"small",type:"danger",onClick:T=>se(w)},{default:l(()=>[i(c,null,{default:l(()=>[i(me)]),_:1})]),_:2},1032,["onClick"])]),_:2},1024)]),_:1})]),_:1},8,["data"])):(_(),E("div",Ie," 请先从左侧选择一个目录 "))],32)],64)):(_(),E("div",De,[f("div",Ae,[t[2]||(t[2]=f("h2",null,"管理员登录",-1)),i(d,{onSubmit:q(L,["prevent"])},{default:l(()=>[i(a,{label:"管理密码"},{default:l(()=>[i(n,{modelValue:A.value,"onUpdate:modelValue":t[0]||(t[0]=w=>A.value=w),type:"password",placeholder:"请输入管理密码",onKeyup:Be(q(L,["prevent"]),["enter"]),autofocus:""},null,8,["modelValue","onKeyup"])]),_:1}),i(a,null,{default:l(()=>[i(s,{type:"primary",onClick:L},{default:l(()=>t[1]||(t[1]=[B("登录")])),_:1})]),_:1})]),_:1})])]))])}}}),Le=$e(Oe,[["__scopeId","data-v-7b0d5565"]]);export{Le as default};
